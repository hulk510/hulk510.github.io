# プロジェクト名

- レンタルサービスのECサイトの開発

## プロジェクトの詳細

業務委託として開発に参加。SSR対応や共通リンクのバグ修正など、主に直したいがリソースが足りておらず放置されていたバグや修正などの開発タスクを担当。

## 使用技術

- フロントエンド：React
- データベース検索：Redash
- ログ管理：Sentry
- 管理画面: Ruby on Rails

## 参加期間

- 2022年2月〜2022年6月

## 開発規模

- エンジニア3名
- その他プロジェクト運営に数名

## プロジェクトでの課題

### フロントエンド

SEO対策のためプロジェクト全体で使われているパンクズリストをHTMLに埋め込んで、表示する必要があった。
パンくずはSPAだと、クライアントがJavascriptを実行してからページを表示するとクローリングする際に取得できないためSEO的にもマイナスということでHTMLに埋め込めるように修正することが課題になっていた。

また、サービス利用ユーザーの流入チャネルのIDをクエリに保持して購入時まで引き回すようになっていたが、購入時までにIDが消えていたため適切に流入チャネルを判別できていなかった。

### バックエンド

管理画面を操作している担当者からデータを登録できないとバグ報告があり、業務遂行ができていなかった。

## 主な取り組み

### フロントエンド

- パンクズリストのSSR対応

  プロジェクトではReactを使っていました。
  Next.jsを使えば比較的簡単にSSRにできるが、すでにSSRの処理部分が作成されていたりとNext.jsへの移行まで含めてしまうと時間がかかってしまうためReactだけで使えるようにするため修正しました。開発タスクを始める際、そもそもSEO的にマイナスになるのか疑問に思い調べた結果、確実にマイナスになるとは言えず不明瞭でありタスクをやったとしてもプラスになるわけではないと考えたので一度相談することにしました。その中でもSSRにしたいという思いがあったため、実装に着手しReactでパンクズのSSR対応しました。

  SSR対応ではパンクズ処理を検索し改修するページの洗い出しを行い、Path一覧のオブジェクトを作成してResponse返却前にパンクズで必要な情報の取得を埋め込みページごとのSSR化を実装していきました。途中記事IDがあるページなど動的なページのパンクズのハンドリングが難しく苦戦した。そのためPathのオブジェクトを拡張しページリクエスト時のパラメータの取得やStateを取得し必要な情報を埋め込みパンクズを返却することで、動的なリンクであっても対応できるようにしました。

  フロントに渡せているかどうかの確認は、Chromeの拡張機能でJavascriptをオフにしたり、ブラウザの検索欄でview-sourceを指定するなどして、HTMLにパンクズが含まれているかを確認しながら行なった。注意していた点としては、全ページの修正を行なってからPRを作成すると大規模な変更点が出てしまいレビューが大変なため、ページごとにPRを作成し１つのブランチにマージしていく形で修正。

- クエリストリングを保持するため共通のリンクコンポーネントの修正。

  消える時と消えない時があると聞いていて愚直に探すと時間がかかると思い、「どの部分でその現象が起きているのか」「どういった場所で発生してそうか」を担当者と確認しながら、まずは原因の調査しました。遷移している際に消えていくと言われていた部分で遷移してみて消えることを確認してから、その中でのリンクの実装がどうなっているかを調べた。結果共通で使っていたリンクコンポーネントではなく、aタグでリンクを作成して遷移していたため途中でIDが消えてしまっていることが原因だった。

  aタグで遷移している部分を洗い出し、適宜リンクのコンポーネントに書き換える修正を行なった。また、他に消える原因が見つかり、history apiでの遷移などはリンクコンポーネントだと対応できないため、history apiでも同じようにリンクを保持できるように遷移時の処理の共通化を行った。共通化に関してはロジック内で遷移させるためのコンポーネント遷移ができないため二重に処理を記述するよりまとめる方がいいと判断したため行いました。

  共通化にあたって、冗長な部分の書き直しを行った。リンクの遷移処理ロジックでは特定のキーを条件分岐で取得して付与する煩雑なロジックになっていたため、その部分の簡素化を行いました。具体的にはクエリ全体からキーを取得する処理、特定のパラメータを取得する処理、それらを今のクエリに付与する処理で分け、遷移時保持するパラメータが増えても配列に追加するだけで対応できるように修正しました。

### バックエンド

- 管理画面での運営側からのバグ修正対応。

  管理画面を操作している担当者からバグ報告を受け、対応できるエンジニアがいなかったためタスクを巻き取り調査。
  ローカルでの再現ができなかったので、どういう操作でそうなったのかをヒアリングをして原因を調べました。
  また、エラー時のログをSentryで確認したり登録できるデータとそうでないデータがあったためRedashを使い該当のデータを検索しました。データを見比べる中で必要なパラメータが存在していなかったことにより、エラーになっていたことが判明したので追加するように修正しました。

## 振り返り

SSR自体の処理はNext.jsでやる場合はそこまで苦労した印象はなかったため、そこまで難しくないと思っていたが、Reactでやるとどういった処理でSSRになるのか分からなかっため苦労した。SSRの概念はNext.jsだけを触っていると、なぜそうなるのか理解できずにいました。そのため、Reactで実装することによってサーバー側での処理とクライアント側での処理の違いが少し理解できるようになったのでやってよかったと感じます。
パンクズを修正する際の検索などもできる限り、いろんな文字で検索をかけ抜け漏れがないかを注意しながら検索しました。最終的にはページ全てのパンクズをSSRにできたのも検索結果をリストにしていたため、修正箇所を毎回探さなくても見つけることができたためよかったと思っています。
また、大規模なページ改修が必要だったためページごとにPRを作成し１つのブランチにマージしていく形で修正することで、細かくレビューできるように注意するようにしました。

リンクの遷移では、今後パラメータを増やす可能性があると伺っていたため追加時に毎回条件を付与するのは無駄だと判断しました。ロジックの共通化を対応しましたが、実際に新しいパラメータを追加した際、簡単に追加でき動作も問題なかっため時間をかけずに修正できました。
