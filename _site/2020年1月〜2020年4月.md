# プロジェクト名

- ホームページのトップページリニューアル対応

## プロジェクトの詳細

学校系のホームページサイトのトップページリニューアル対応。
リニューアルページのhtml, css, jsなどは別の方が作成してくれていたので、cmsに取り込みホームページとして表示する部分を担当しリニューアルに合わせて他ページの修正。

## 使用技術

- 管理画面（社内パッケージcms）： PHP
- インフラ： k8s, Vagrant

## 参加期間

- 2020年1月〜2020年4月

## 開発規模

- 4人

## プロジェクトでの課題

ホームページのトップ画面のリニューアルに合わせて、各所のページコンテンツなどを新しくしたかった。
しかし、トップページではhtmlがハードコーディングされていて、適切に記事情報を取得できる状態になっておらず汎用性の面において課題があった。そのため、記事作成をしても適切にトップページに表示されない問題が起きていた。

リリース後、ホームページがダウンしていた際に修正できる人がいなかった。

## 主な取り組み

### 管理画面

- cmsで記事やその他コンポーネントのパーツ化とトップページテンプレート化

  ハードコーディングされていた原因としては、html, cssは別途他の方が完成版を作成して取り込む形になっていたため、それをそのまま入力できる形にしていた結果今回の現象が起きていたと考えている。

  html内部では記事の情報などは仮で置かれてるため都度修正する必要があったが、記事のリンクや埋め込みを行うことはあまり現実的でなかったためリニューアルに合わせてその部分の改修をした。
  開発タスクとしてはやる必要のなかったタスクですが、今後サイトリニューアルする際、もう一度自分が対応することになると嫌だったので修正することにしました。

  具体的には、

  - 納品されたhtmlからsectionごとにコンポーネントを分け適切なパーツに分解

    パーツにする機能自体はcmsに用意されていたため、htmlで必要な箇所ごとにパーツを作成していきました。テンプレートにして表示するまではパーツ単体でのプレビュー機能がないため、あまり細かく分けずにsectionごとで分けるようにしました。

  - パーツ内部の情報を検索する機能の実装

    パーツ内部ではphpのコードを埋め込むことができ、そこから記事の情報などを検索して埋め込めるためgroongaの検索の機能を実装し記事データの取得、埋め込み、表示できるようにしました。そして作成したパーツからテンプレートを作成し、パーツ構成の変更でページを表示できるようにしました。検索機能自体は、社内ドキュメントにあったものから実装しましたが、cmsのバージョンが古かったため動かず苦戦しました。groongaのバージョンで書き方などが変わっていたため適宜Webで調べながら、phpでデバッグコードを打ち込みながら実装しました。

  - 記事の情報を作成できる管理画面ページを作成

    パーツに表示する記事のデータを登録するページを作成する必要があったため、php内部の設定、DBスキーマを変更し、groonga検索indexを貼り直しました。バリデーションやセレクションなどはphpのコードで指定すれば変えられたため、他ページの実装を見ながらページを作成しました。一番苦戦したのは作成した記事をドロップダウンに一覧で表示して記事のリレーションをつける部分でした。トップページで使うため実装する必要がありましたが、古いバージョンの仕様を知ってるものがいなかったため、cmsのコア内部の処理や他のプロジェクトなどの実装を参考にしました。jQueryで別途記事検索するAPIがあったため、ページ内部から要素をタップした際に検索APIを叩きドロップダウンに値を表示し登録できるように修正しました。

### インフラ

- 障害が起こった際の情報収集と共有

  リリース後、ホームページがダウンしてることに気づきk8sの操作などは一通り聞いてはいたため、障害対応を行ないました。
  gkeのエラーログを見つつサーバー内部に入って確認しましたが、当時の実力では解決できない問題だと判断し、社内のエンジニアで対応可能な人に頼み修正を依頼しました。
  本番環境だったこともあり、調査に時間をかけるべきではないと思い社内のプロジェクトリーダーに共有し対応可能なエンジニアを見つけてもらった方が解決は早いと判断しました。
  緊急で参加してくれたエンジニアに、プロジェクトの状況、エラーの状態など調査したところまでの共有しつつ、別プロジェクトから来てすぐに調査できるよう意識して情報を共有しました。

## 振り返り

古いパッケージでドキュメントも少なく、保守状態で死活監視のみが動いてる状態だったため常駐しているエンジニアがおらず、コードや昔のタスクなどから調査する作業がとても辛かった。特にcmsのバージョンが他プロジェクトよりも古かったので書き方や細かい部分でどうなっているのかの把握に時間がかかった。ただ良かった点としてこの経験から、ドキュメントがなくても今動いてるコードがコードを読み、実行コードのデバッグが可能であればある程度は理解できるなと思いました。またドキュメントの大切さを思い知りました。

障害対応では、どこまで共有が役に立ったのかは分かりませんが、約3時間ほどで原因の特定と修正ができました。起きていた現象としては、リニューアル時にdocker image内部で使われているモジュールのバージョンが変わっていて、適切に処理できずエラーになっていました。私だけだと、より調査に時間がかかっていたので頼んだことで素早く解決できて良かった。
