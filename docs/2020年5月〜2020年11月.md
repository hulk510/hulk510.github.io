# プロジェクト名

- 予約サービスのAPI開発

## プロジェクトの詳細

予約サービスのフロントとロッカーAPIを繋ぐAPIの開発。
また、サービスで使う決済基盤のAPI構築。

## 使用技術

- API: gRPC, Go

  エンドポイントになるAPIとDBからデータを受け取って処理するAPIなど社内パッケージが複数に分かれており通信にはgRPCを使用していました。

- 決済モジュール：PHP、Laravel
- API周辺：Rest Client, Postman, Swagger

## 参加期間

- 2020年5月〜2020年11月

## 開発規模

- 全体では20人ほど
- API周りは3人

## プロジェクトでの課題

サービス上、他社APIを社内会員基盤と連携しフロントエンドにAPIとして提供する必要がありました。また、APIの実装に合わせてAPIを作成するためフロントエンドとの連携に時間がかかる課題も発生していた。決済機能においては、モジュールがPHPのため別途PHPでのAPIを用意することが課題でした。

## 主な取り組み

- ロッカーAPIの実装

  社内パッケージでは、ログイン機能などRedshiftへの基本的なAPIが既に実装されていたため、プロジェクトで使用する連携先APIにリクエストするAPIを実装する必要がありました。APIの実装には、Go内部のパッケージnet/httpを使用して、クライアントを作成し、APIを呼び出してデータを取得しました。APIの実装にmo苦労しましたが、より大きな課題は、社内パッケージの使い方を学ぶことでした。少し特殊なパッケージで、ドキュメントの読解や他のプロジェクトでの実装を参考にしながらAPIを実装しました。また、パッケージが新しかったあったのもありドキュメントが少なく、概念の理解が困難だったため、パッケージの挙動を理解するために多くの時間を費やしました。
  中でもgRPCの通信部分のファイルを読んだり、社内の実装者と共に勉強会を実施したりしながらパッケージの理解を深め、API構築を担当していた同僚と知見を共有し概要の把握と使い方だけを理解できるようにしました。複雑なパッケージのためタイトな開発スケジュールの中で全てを理解するのが難しく、あまりコードリーディングばかりに時間をかけず実装で必要な知識を素早く吸収できるようにする必要があると判断しました。
  APIのテストには、最初Postmanを使用しました。その後Rest Clientに切り替え、コードベースで管理し共同開発者と共有できるようにしました。私と同僚どちらもVSCodeを使っていたため、APIを試せる環境をお互いで共有できるようにしておきたかったためです。

- Swaggerを使用したAPI仕様書の作成とモック作成

  フロントエンドが使用するAPIの仕様書として、Swaggerを使いAPIに必要なリクエストパラメーターやレスポンスなどを定義しました。Swaggerを導入することになった背景は、ymlファイルでAPI仕様書を作成できるため、スプレッドシートで作成する場合に比べてバージョン管理や編集が容易であるという点でした。社内エンジニアと協力して、SwaggerでAPI仕様書を作成しました。Swaggerは構造体を定義してresponseに含めたり、共通化できるため、同様の処理が多い場合にパラメータを共通化することでパラメータ変更にも対応できるようにしました。開発中、連携先APIの具体的な仕様がまとまっていなかったり、もらっていた仕様書とAPIが違っていたりと、開発が円滑に進まないことがありました。そのため、開発する前にSwaggerでAPIの仕様書を定義することで、フロントエンドにAPIの提供をする前にどういったリクエスト、レスポンスを共有することで開発が遅れることを防ぎました。
  どうしてもAPIの開発が遅れてしまう場合は、極力フロント側の開発が止まらないようにモックサーバーとして同じ固定レスポンスを返すことでフロントエンドの開発が後ろ倒しにならないよう気をつけました。モックサーバーではリクエストに含めるパラメータで異なるテストデータを返し、エラー時のテストなどフロント側で行えるようにしました。そして、APIが実装され次第、差し替えるだけで動作するよう開発を進めました。連携先APIのリクエストやレスポンスが変わりAPIを新しくする場合もAPIの仕様書の変更を先に行い、同時並行で開発が進められるようにしました。

- 決済基盤API部分のフルスクラッチ実装
  決済モジュールは、別ベンダーが作成したものを使用しました。モジュールはPHPで作成されていたため、PHPで決済モジュールを組み込んだAPIを作成する必要がありました。実装に際して手軽にAPIを開発するためにLaravelを採用しました。採用理由としては、APIの実装が構築段階から使用可能であり、API処理の実装がpurePHPを使用するよりも早く実装できると判断したためです。
  実装に当たって決済処理の仕様調査を社内で行い、仕様書から必要なAPIを洗い出し実装をしました。APIの洗い出しでは、そもそも決済処理の知識がなかったため概念を理解することに苦戦しました。そのため、モジュールのドキュメントや基本的な使い方などを調べながら実際の決済フローを思い出しながらどういった部分でどの機能が使われているのかをフロー図に書き出しながら洗い出しました。そして、社内でドキュメントからどのAPIで実現しているのかを話し合っい必要な機能の実装をしました。
  実装では、モジュールをPHP内のクラスから扱うことができるため、API内部で呼び出すことができ使用するメソッドを定義したりパラメータを渡すだけだったため、簡単に実装できました。

## 振り返り

- 実践的なAPI開発や他社API基盤との連携経験

  実装にかけられる時間が少なくタイトなスケジュールでの実装になりましたが、フレームワークやモックを使うことで大きな遅れもなく実装できたと考えています。また、APIだけの開発をするのは初めての経験だったため、実践的なAPI開発や他社API基盤とのAPI連携など、フロントエンドだけを使っていた場合よりもバックエンド側の繋がりを意識できるようになりました。
  そして、アウトプットとしてAPIでresponseを返すにあたって、具体的な値の返し方がよくわからず調べ記事書いたりする中でAPIの理解が進んだと感じています。[json作る時の自分なりの考え方 (zenn.dev)](https://zenn.dev/hulk510/articles/bf585a91d6e1b1286e07)

- 改めて分かったフレームワークの良さ

  プログラミングを始めた時は何も分からずフレームワークを使っていて、なんかできてるみたいな状態でした。フロントエンドやバックエンドを経験する中で基本的な処理や流れを理解し改めてフレームワークを使ってみた感想として確かに手に余る機能など多かったりするが、その分理解できると開発が早くなるし便利ということでした。特にエスケープや脆弱性を産まない設定などもプロパティの設定のみで可能になったり、開発において実装するのめんどくさい作業などが省略されているなと実感しました。
  便利にするためのフレームワークなので当たり前ではあるのですが、今までよく分からなかったフレームワークが私の中で新しく便利なツールになったと考えています。

- 普段知らない分野を知れる楽しさ
  「与信のため最初に少量決済する」など、決済領域の常識や文化などがWebサービスの開発を通して知ることができ、楽しく開発できたと考えている。また、物理的なロッカーをAPIを使うことで間接的にでも操作出来たのは今までにない経験で面白かった。書いたコードが実機で動いてるのを見て、実感はなかったが操作できているという不思議な感覚だった。
