# プロジェクト名

- SwiftUIを使ってリモートでの孤独感を埋めるアプリの0→1開発

## プロジェクトの詳細

話したい人とすぐ話せるアプリStayONの開発
https://prtimes.jp/main/html/rd/p/000000012.000049339.html

<img src="https://i.gyazo.com/dbbb905de9773834432689fd0d619565.png" width="150rem" />
<img src="https://i.gyazo.com/02de61d5c6cb0fb251dc230048bcafc7.png" width="150rem" />
<img src="https://i.gyazo.com/ffce977a187eb4cb7887f6d6cde5f4e9.png" width="150rem" />
<img src="https://i.gyazo.com/4877df3e249a6f492bdefb69cd163094.gif" width="150rem" />

## 使用技術

- Firebase:
  - RealtimeDatabase
  - Firestore
  - Auth
  - Cloud Messaging
  - Analytics
  - Crashlytics
  - Extensions
  - AppCheck
  - Performance Monitoring
- バックエンド
  - Firebase CloudFunction
- クライアント
  - SwiftUI
- 通話、画面共有
  - Agora

## 参加期間

- 2021年11月〜2022年11月

## 開発規模

- 5人
  アバター画面担当エンジニアが別途ひとり参加でそれ以外の部分を担当

## プロジェクトでの課題

他に技術者がいない状態でメタバースに絡めたコミュニケーションアプリの実現とアプリのアイデアを考える必要がありました。

## 主な取り組み

### アイデアからプロダクト決め

このプロダクトを作るきっかけは、コロナ禍で人とのコミュニケーションがオンラインで完結し起きた課題をメタバースで解決できるのではないかと考えたのが始まりです。
企画を作成するにあたってどんなプロダクトにするか考えるため一通りメタバースと言われていたサービスやゲーム、通話アプリなどを体験して理解を深めていきました。体験する中で個人的に一番課題に感じていた部分としては、アバターや世界それ自体がよりも如何にコミュニケーションをとりやすくするかだという点でした。誰かわからない相手に話すハードルが高く、何故そんなにもみんなが話せているのかが分かりませんでした。リモートで会話する相手がいない状態で孤独を感じてはいるものの、実際に相手に向けて一歩を踏み出せていないと感じていました。
そのため、メタバースにおいてもまずは知らない人とのコミュニケーションをもっと楽に、偏見を持たず気軽に話せる必要があると考え、課題の定義とその課題をどうすれば解決できそうかの検証をしました。

### 検証

いきなりアプリを作り始めるのではなく、まず小さいコミュニティで検証しながら進めていくことにし、Discordでのサーバー運営を始めました。Discordを選択した理由としてはゲームと親和性が高かったこと、チャットや通話などサービスを運営する際のプラットフォームとして近い形で検証できると考えたためです。

サーバー運営には運営されてる他のサーバーの構成を参考にして自分のサーバーに適用しながら雛形を決め集客を行いました。他のDiscordサーバーやSNS、Disboardなどに宣伝をして200人ほどをサーバーに集めました。宣伝する際何故そのサーバーを運営しているのか分からず宣伝文句を作るのに苦労しました。プロダクトの目的がコミュニケーションと抽象的な目的だと人を集めづらく、目的を何と定義するのか悩むことがありました。明確な目標ではないですが私がやっていた趣味やゲームそれらを一緒にやりつつ集まった人たちで仲良くやろうとふわふわした目的を設定することで、やりたいことで集客をかけ来た人とも話せるため運営がやりやすくなりました。
サーバー参加時に自動で最初のメッセージを送ることで、来てくれた人とまずは挨拶や自己紹介などを話しかけるようにしました。少しでも話ができると、してない時に比べてサーバーにいてくれたり他のチャンネルで会話する率が増えたため、複数人いる中で自分からは話しづらいと考え、適当に会話をしてまず私を知ってもらえるようにしました。話を聞いていると実は話したいと思って参加したけど話せない人が何人かいたため、コミュニケーションにおける当初の課題は各々感じている問題なのだと考えていました。

また、人が増えるに合わせて管理ができず次何するか分からない人が増えてきたため、他サーバーのBotを参考にどういった運営を行なっているかを見ながらBotの設定をしました。Botの導入ではリアクションロールや投稿に合わせて自動返信するBotを導入したり、チャンネルを作成するBotや、SpeechToTextを使い通話時の会話をテキストにして他の人も見られるようにするBotを自作しました。よりみんなが自由に部屋を作ったり、サーバーの機能として見える部屋を変えて棲み分けをしたりしながら、話したい人と話すためこれらの機能を導入しました。そして、検証した際の結果がどう変わったか分かりづらかったため、サーバーのメトリクスを取るBotを入れることで確認できるようにしていました。

運営して見えた課題としては、チャットは動くが通話はあまり動かないということでした。通話だとコミュニケーションで多くの情報を伝えることができ、メタバースにおいても重要な要素だと考えていたため通話の課題を深掘りをしました。
一番の課題は最初の一人が参加しづらいことでした。そのため、自分がまずは最初の一人として参加してみようと空いている時間をずっと通話に参加してみました。初めは一人でしたが、ずっといると気になった人が入ってきて来てくれることがあり2人で話しているとさらに他の人が参加してくれることが分かりました。私もそうですが、通話に入っているという状態が他の人にわかる状態で誰も入ってこない経験は辛くみんなオンラインなのに入ってきてくれない辛さがあると考え、最初の一人が待ってくれる状態を作れるようにする必要があると考えました。
通話部屋を作り区切られた状態で最初の一人にならなければいけないといった形式そのものが邪魔していると考え、壁を取り払うためSpacialChatを使った検証をしました。同じ部屋で近づくと話せる状態で会話の可視化ができ、他の人に近づいて話したり離れて違う人と話したりとリアルな会話を体験できました。そして、それらの結果からアプリの概要や機能の草案を作成し作り始めました。

アプリを開けばすぐ話せる状態で参加、近くに行くと声が聞こえる体験をアプリでできるようにする、6人以上での会話はしづらいため1グループ6人で他の会話も聞きながら会話ができるようにするなどの機能案を作成しました。そしてその実現に必要な機能を話し合いながらアプリの作成を始めました。

### 開発

作成した機能の草案やユースケース図からデザインモックを作成し実装にあたりました。開発初期はデザイナーがまだいなかったため、Figmaで簡単な画面のデザインを作成しました。デザインに関しては素人なためあまり時間をかけず、頭の中の完成系の共有ができる程度に必要な機能をざっくり置いた簡素なものを作成できるようにしました。
開発にはフレームワークとしてSwiftUIを使用しました。SwiftUIはチームで相談してApple公式でドキュメントや記事などが見つけやすいこと、アプリ開発が初めてで一人での開発なためiOS特化でAndroidなど考える点が少ないことで採用しました。実装にあたって、Xcodeを使う以外のことは何もわからなかったのでアプリを作成する本を買い、本に沿ってサンプルコードを作りアプリ開発に慣れることから始めました。一冊を終えただけでは知識不足でしたが、一通りSwiftUIの使い方を学べたため勉強するより実装しながらつまづいたタイミングで調べるようにして慣れればいいと考えアプリの制作を始めました。他にもやるべきことがたくさんあったため、あまり時間をかけて学習するよりも慣れる方が早いと考えたからです。しかし、実装を始めてみると初期デザインに沿った実装は思った以上に難しいものでした。適当に画面に配置しただけのデザインで実装のことを考えておらず、どうすればデザイン通りに実装するのかも分かりませんでした。viewModifierの設定など分からないことが多かったため、デザインに完全に沿った開発は一旦諦めデフォルトの機能でデザインを作成するようにしました。アプリで作りたかった機能の実装を早く行なって共有できることが最優先だと判断したため、そのように進めました。

#### 導入したもの

短期の開発スケジュールで早く初期構想の機能や体験を実装してリリースするためAgora、Firebase、 Github Projectを使い、開発で考える部分を少なくするようにしました。

- Firebase

  インフラやサーバーをゼロから立てると時間がかかるため、一人で開発することを加味するとできる限りスピーディーにアプリを仕上げるため全てが1つでできるFirebaseを使用しました。また、プッシュ通知、CloudFunctionなど拡張性があり、無料範囲内であれば料金はかからず安くサービスを始められるなどの理由で採用を決めました。
  開発環境はEmulatorを使用し構築しました。アプリ別で開発環境を分けるにはアプリのBuildIdentifierを変えたりとよく分からなかったため諦めましたが、ローカルでテストする環境がないと本番リリース時に開発できないため必要と考え導入しました。EmulatorではテストデータをGithubでUnity画面を担当していたエンジニアと共有しimportすることでデータをロードして開発できるようにしました。schemeのbuild configureを切り替えることでむき先を変え、アプリ内で本番の動作確認ができるようにコード修正し素早く環境を切り替えて開発環境を整えました。

- Github Project

  タスク管理はGithub Projectを使用しました。Githubでタスク管理するとissue、 PRの紐づけやタスク管理が簡単にでき、開発タスクが頻繁に変わる中でRedmineやBacklogなどのチケットツールよりスイッチングコストが低いと考えたためです。
  Github Projectはbeta版だったのですが、少し使ってみたところシートを分けて看板ボードや、スプレッドシートを作ることができてタスクや進捗確認に十分使いやすいと判断したのも導入理由の1つです。そして、Webhookを設定し社内のDiscordに変更や修正点の通知を送り確認できるようにしました。

- Agora

  通話および画面共有のライブラリとしてAgoraを採用しました。採用理由としてはTwilioやその他のライブラリと比較して豊富なサンプルコードやチュートリアルがあること、画面共有機能など拡張性も高いことが主な理由です。また、ClubhouseでもAgoraが採用されておりアプリでやりたいことと似ていたため、作れそうと考えたのも理由の1つです。本格的な運用になる場合は自前で開発することになると考えたため、あまりライブラリの違いに悩まず必要な機能を実現するために安価で使いやすいライブラリを早く決められるようにしました。通話に使うためのトークンを生成するサーバーは公式のサンプルをコードに落としてGoとHerokuで作成しました。Herokuはサーバーへのデプロイが簡単でトークンを返すサーバーと簡素な機能で足りたため採用しました。

#### 実装した機能

- チャンネル機能

  チャンネル機能ではユーザーがアプリを開いた時に、参加して通話ができる機能として実装しました。RealtimeDatabaseを使用してプレゼンス確認をトリガーにして、CloudFunctionのバックグラウンド関数でFirestoreのユーザードキュメントを更新し、オンライン状態を管理しました。アプリを開いているオンラインのユーザーをチャンネル内に表示することで、今話せるユーザーを表示する機能を実装しました。
  チャンネル内のユーザーをタップするとFirestoreでドキュメントを作成し同じグループに登録させaddSnapShotListenerを使いリアルタイムで表示し他のユーザーと話せるようにしました。
  また、ユーザーのつぶやきをタイムラインと同じドキュメントで管理しながら、最後に投稿したつぶやきをアイコンの上に表示することでタイムラインと同期しながら今いる人達がアバターで話せるようにしました。チャンネルに登録しているデータはユーザーの情報が変わってもアップデートされないため、ユーザー情報変更時をトリガーにグループ内のユーザーを検索してユーザー名などが自動で変わるようにしました。

- タイムライン機能

  つぶやき投稿の返信時、ドキュメントの返信数をインクリメントするバックグラウンド関数を設定しました。その関数内で返信時に返信されたユーザーのfcmTokenを取得しプッシュ通知を送れるようにしました。返信したユーザーの一覧がアイコンで見えるようにするため、ドキュメントにユーザーのアイコンをハードコーディングすることでいちいち読み取らずに1つのドキュメントで表示できるようにしました。タイムラインではその世界のログが掲示板になっているイメージで作成しました。

- ログイン、ログアウト機能

  Firebase Authに用意されているSignInWithAppleを使用してログイン機能を実装しました。
  ログイン後はユーザー情報をリアルタイム取得し、取得したObjectを他のコンポーネントからアクセスできるようにFirebaseFirestoreSwiftパッケージを使用してユーザー構造体に変換し使い回しました。
  退会機能はFirebaseのドキュメントにはなかった為、Flutter用に書かれていた退会処理をCloudFunctionで書き直しクライアントからリクエスト出来るように退会処理を作成しました。refreshTokenをログイン時保持するようにしていなかったため、退会前にもう一度ログインさせ取得したあとリクエストすることで退会処理を行いました。退会したユーザーのドキュメント削除は人力でやると大変なため、拡張機能を使用し自動で削除しました。

- 通話機能
  AgoraのサンプルコードやExampleプロジェクトを試していたため、通話機能に必要な機能は比較的容易に実装できました。通話をグループごとに分けるため、Agoraから生成される部屋IDや話者をFirebaseのドキュメントに登録しました。これにより、通話に参加する側が参加している通話部屋の情報を取得してグループを分けた通話を実装しました。実装する際はXcodeで定義されている処理がサジェストで表示されるため、Agoraの通話機能に適した処理で使えそうなdelegateメソッドがあればドキュメントで仕様を調べAgoraの機能でできないかを調べました。通話に参加したイベントなどはアプリ側の実装ではなく、delegateメソッドで検出するなど無駄にコードを書かずに開発できるように心がけました。

- 管理操作にFirebaseAdminSDKを使用

  テストドキュメントを作成したり本番のデータを作成する時に、Firebaseの管理画面から地道に追加する方法では時間がかかるため、FirebaseAdminSDKで登録データを自動で作成できるようにしました。CloudFunctionと同じ書き方ができるため時間をかけて管理画面から登録するよりもスクリプトを実行する方が何度も行う場合便利なため使用しました。

#### リリースにあたってやったこと

- デザインのリニューアル

  途中からデザイナーが参加することで元のデザインをリニューアルしながら合わせて実装のブラッシュアップも並行して行いました。設計から見直す必要があったりリリース期限も2ヶ月と決められていましたが、機能を一度実装しきったことで勘所がわかったりと初期の頃に比べて実装力が少しついてきていたためスピード感を持って作ることができました。どうしても開発タスクがかさみ間に合わない場合は、リリースまでにやることやらないことのタスクを調整しながらどの機能がリリース時にあればいいのか決めて進めました。

- Firebaseのルール作成AppCheckによるセキュリティ強化

  セキュリティの設定をしないと誰でもリクエストできてしまうため、Firestoreのルールを作成して登録できる情報を制限しました。ルール内ではscheme検証、許可するパラメーターのバリデーションをかける関数を作成し、リクエストされるパラメータの検証をしました。
  Firestoreの本でwrite権限のルールはアンチパターンと書かれていたため、個々のイベントでルールを作成しリクエストで必要なパラメータ毎にアップデート検証を書くようにしました。Firestoreのルールはどの部分でエラーになるのか詳細が出ないため、実装時にデバックがしづらく苦労しましたが、適宜ルールを緩くしたり厳しくしたりしながら差分で原因を特定しながらルールを作成しました。

- 2Dアイコンの作成プレゼン資料作成

  リリース前までは仮で使っていたアバター画像だったため、商用利用できる形の画像にアップデートしました。アバターの部位ごとでどう言ったものにしたいのか、イメージに近い画像をいくつかピックアップして基本要件やアプリの雰囲気に合わないデザインなどを盛り込み2Dアイコン四体の作成依頼のトンマナ資料を作成しました。

- アップデート文のGithub Discussion管理

  バージョン毎のアップデート文の履歴や、訂正がある場合はコメントを残して修正できると考えDiscussionに貼ることで残しておきました。スプレッドシートなどで文言ファイルを作るよりもGithubで管理できた方が変更点を貼り付けてどう言った修正をしたのかみれるようにできるため便利だと判断しました。

- アプリの審査・デプロイ

  審査ではAnalyticsのトラッキングの許可モーダルを出していないこと、タイムラインでユーザーのコンテンツをフィルター機能実装が必要、退会機能がないなどさまざまな理由でリジェクトされたため修正しました。

### アプリリリースと改善

- アプリリリースの間隔を細かくした
  ずっとTestFlightで開発して、いくつかの機能ができるまで審査に出していなかったため、一度に多くリジェクトがある時は修正するまでリリースできず大変でした。そのため、実装できたら審査してもらうように変え、リリース数を多くする形に変えました。バグや新規開発など常にアップデートしていく必要もあり、他の部分の修正対応でパッチが出せない状況にならないように気をつけました。
  また、アップデートによって使える機能が変わる際は、Firestoreにバージョンを指定するドキュメントを作成し、起動時にアプリのバージョンがそれ以下ならアップデートを促すviewを表示するようにしました。その際、title、 body、 AppStoreのURLなど自由にアラートの文言を変えられるようにしました。

- miroを使ったユーザーの動向整理

  企画、開発をして気づかなかったのが、ユーザーにとってはアプリの操作説明が分からないことでした。自分たちはこういう機能でってのは理解していても、利用者は何の説明もなくUX的に尖ったものを出してしまっていました。その為、躓く点や使いにくい点などアプリを使ってもらいインタビューし、フィードバックをもらった上で出た課題やユーザーの動向をmiroで付箋を貼りながらチームで整理しました。通話に参加するまでの流れが分かりにくい部分は説明ページを挟むことでアプリのユーザーに対してのUX向上を行ないました。

- オンボーディングページの作成

  ユーザー作成時ログインするといきなりホーム画面に遷移してしまうため、オンボーディングページを作成してユーザーのセットアップ画面を作成しました。また、完了時は世界に入った感を出すためアニメーションを設定し画面の切り替えを実装しました。画面の切り替えは遷移ビューでは行わず、sectionの番号を保持してswitchでviewを出し分けることでオンボーディングページを切り替えました。

- Twitterのアカウント運用

  社内で作成されていたアプリのTwitterアカウントは最初の宣伝だけを行なって、それ以降使っておらずもったいないと感じたためTwitter運用を代わりにしました。アプリの使い方を説明した画像を作成して紹介したり、アップデートの通知や取り止めもないつぶやきをしたりしながらアプリを露出するタイミングを増やせるようにしました。

- 画面共有機能

  通話中アバターでできることが少なく暇になってしまうことが課題で、画面共有ができると表現の幅が広がると考えAgoraのライブラリを使用して導入しました。実装途中で動かない部分があったりと、画面共有の実装には不足している知識が多かったため苦労しました。共有処理内部はCで書かれていたりと処理を完全に理解できなかったため、サンプルの処理部分を改変しながらいじったり、公式ドキュメントを読むことに時間を費やしなんとか動くレベルの実装をしました。また、相手の画面を共有する開始タイミングでAgoraに画面結果を渡し、描画結果をViewに表示し画面共有を実装しました。

## 振り返り

- 心残りだったこと

  最初の一人をどう作るかの解決策をもっと具体的に検証して考えておけば良かったなと考えています。Discord検証時のように自分が一人ずっと居て、ある程度人を集めれば勝手に集まってくるとそこまで深く考えていなかったために、居ない時にはあまり会話の自然発生を実現できませんでした。機能をすぐに考える前に、会話が発生する要因の仮説検証をしたりモックでインタビューするなど行動を増やすべきだったと感じます。実装があるからと仕様や機能を焦って進め、結果的に課題を解決するプロダクトとして刺さらない尖ったアプリになりプロダクト開発の難しさを痛感しました。

- 良かったこと

  最初から綺麗なもので出したいがタイトな開発スケジュールなため時間もないという葛藤があり、リリースして修正していくスタイルで進めるのは抵抗感がありました。しかし、リリースを重ねるうちにアプリが良くなり、細かく検証してフィードバックを得られたことで徐々にその考え方は変わってきてむしろ自分たちが考える完成を実装するまで待たなくて良かったなと考えています。
  あとは、当たり前ですが、SwiftUIでの実装力がついたことです。今までアプリを作ってみたいなと思ってはいたもののXcodeを触ったりアプリ独自の仕様を知るのがどこかめんどくささを感じて挑戦できていませんでした。そのため、こういう機会で挑戦できアプリ開発に携われたことは良かったと考えています。やることが多く、開発も相談できる人がいない状態で苦労することは多々ありましたが、試行錯誤しながらも完成させた経験は私の自信につながったと考えています。
